"use strict";(self.webpackChunkmy_docs=self.webpackChunkmy_docs||[]).push([[5935],{8453:(e,r,n)=>{n.d(r,{R:()=>i,x:()=>a});var s=n(6540);const o={},t=s.createContext(o);function i(e){const r=s.useContext(t);return s.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function a(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:i(e.components),s.createElement(t.Provider,{value:r},e.children)}},9656:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>d,contentTitle:()=>a,default:()=>h,frontMatter:()=>i,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"Database-Layer/error-handling-in-drizzle-orm","title":"Error handling in drizzle ORM","description":"Background:","source":"@site/docs/Database-Layer/error-handling-in-drizzle-orm.md","sourceDirName":"Database-Layer","slug":"/Database-Layer/error-handling-in-drizzle-orm","permalink":"/open-pocket-docs/docs/Database-Layer/error-handling-in-drizzle-orm","draft":false,"unlisted":false,"editUrl":"https://github.com/abdulrahim2002/open-pocket-backend-server/tree/docs/docs/Database-Layer/error-handling-in-drizzle-orm.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"title":"Error handling in drizzle ORM","sidebar_position":3},"sidebar":"tutorialSidebar","previous":{"title":"Database Schema","permalink":"/open-pocket-docs/docs/Database-Layer/database-schema"},"next":{"title":"Processes","permalink":"/open-pocket-docs/docs/category/processes"}}');var o=n(4848),t=n(8453);const i={title:"Error handling in drizzle ORM",sidebar_position:3},a="Notes on error handling in drizzle ORM",d={},c=[{value:"Background:",id:"background",level:3},{value:"Temprorary solution",id:"temprorary-solution",level:3}];function l(e){const r={a:"a",code:"code",h1:"h1",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(r.header,{children:(0,o.jsx)(r.h1,{id:"notes-on-error-handling-in-drizzle-orm",children:"Notes on error handling in drizzle ORM"})}),"\n",(0,o.jsx)(r.h3,{id:"background",children:"Background:"}),"\n",(0,o.jsxs)(r.p,{children:["Drizzle depends on database drivers to perform actual operations on the database. For ",(0,o.jsx)(r.code,{children:"postgrsql"})," database ,drizzle supports ",(0,o.jsx)(r.a,{href:"https://github.com/postgres/postgres",children:"postgresjs"})," and ",(0,o.jsx)(r.a,{href:"https://www.npmjs.com/package/pg",children:"node-postgres (also called pg)"})," as ",(0,o.jsx)(r.a,{href:"https://orm.drizzle.team/docs/get-started-postgresql",children:"documented on their website"}),"."]}),"\n",(0,o.jsxs)(r.p,{children:["Now the problem is, since drizzle does not perform the database operations itself it gets success/failure information about the operation through ",(0,o.jsx)(r.strong,{children:"errors/messages"})," returned by the underlying driver."]}),"\n",(0,o.jsxs)(r.p,{children:["The drizzle's session layer is driver agnostic. So the database interation code ",(0,o.jsx)(r.a,{href:"https://github.com/drizzle-team/drizzle-orm/blob/37d059f95ebe4ca7da6e60415de0164c729a8454/drizzle-orm/src/pg-core/session.ts#L71C4-L71C25",children:"looks like this"}),":"]}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-typescript",children:"try {\n    return await query();\n}\ncatch (e) {\n    throw new DrizzleQueryError(queryString, params, e as Error);\n}\n"})}),"\n",(0,o.jsx)(r.p,{children:"Basically, it just tries to run the query using the database driver provided, and in case, any error is thrown at a lower level, it just:"}),"\n",(0,o.jsxs)(r.ul,{children:["\n",(0,o.jsxs)(r.li,{children:["throws a new ",(0,o.jsx)(r.a,{href:"https://github.com/drizzle-team/drizzle-orm/blob/37d059f95ebe4ca7da6e60415de0164c729a8454/drizzle-orm/src/errors.ts#L3",children:(0,o.jsx)(r.code,{children:"DrizzleQueryError"})})]}),"\n",(0,o.jsxs)(r.li,{children:["the original error is attached to the ",(0,o.jsx)(r.a,{href:"https://github.com/drizzle-team/drizzle-orm/blob/37d059f95ebe4ca7da6e60415de0164c729a8454/drizzle-orm/src/errors.ts#L9",children:(0,o.jsx)(r.code,{children:"cause"})})," field"]}),"\n"]}),"\n",(0,o.jsx)(r.p,{children:"There are several problems with this approach:"}),"\n",(0,o.jsxs)(r.ul,{children:["\n",(0,o.jsx)(r.li,{children:"the type of error thrown cannot be ascertained"}),"\n",(0,o.jsxs)(r.li,{children:["drizzle is providing no abstraction, and the developer needs to figure out ",(0,o.jsx)(r.strong,{children:"what went wrong"})," by understanding the error thrown by the underlying driver."]}),"\n"]}),"\n",(0,o.jsx)(r.p,{children:"Though I think this is a difficult problem, because:"}),"\n",(0,o.jsxs)(r.ul,{children:["\n",(0,o.jsxs)(r.li,{children:["if drizzle depends on individual database drivers and throws errors based on them, then it is no longer ",(0,o.jsx)(r.strong,{children:"driver agnostic"}),"."]}),"\n",(0,o.jsxs)(r.li,{children:["it is difficult to track down each possible error the ",(0,o.jsx)(r.code,{children:"database"})," driver and throw. And since, it must support multiple drivers, it needs to define a common interface, that can cover all possible errors."]}),"\n"]}),"\n",(0,o.jsxs)(r.p,{children:["I think the best approach out here, is to define a common interface for all Errors (can expand DrizzleQueryError to include more fields). And then, in the catch block above, try to find out what went wrong and populate as must information we have before we throwing the ",(0,o.jsx)(r.code,{children:"DrizzleQueryError"}),"."]}),"\n",(0,o.jsx)(r.h3,{id:"temprorary-solution",children:"Temprorary solution"}),"\n",(0,o.jsxs)(r.p,{children:["I'm using ",(0,o.jsx)(r.a,{href:"https://www.npmjs.com/package/pg-protocol",children:(0,o.jsx)(r.code,{children:"node-postgres"})}),".  And I found out that it actually uses ",(0,o.jsx)(r.code,{children:"pg-protocol"})," under the hood."]}),"\n",(0,o.jsxs)(r.p,{children:["Upon failure, it throws a ",(0,o.jsx)(r.a,{href:"https://github.com/brianc/node-postgres/blob/917478397b0cfbb95f0275e1974a72bb581b07a9/packages/pg-protocol/src/messages.ts#L97",children:(0,o.jsx)(r.code,{children:"DatabaseError"})})," with the error code and message in accordance with ",(0,o.jsx)(r.a,{href:"https://www.postgresql.org/docs/current/errcodes-appendix.html",children:"postgres error codes as described here"}),"."]}),"\n",(0,o.jsx)(r.p,{children:"So I build the following solution, to detect errors:"}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-typescript",children:'import { DrizzleQueryError } from "drizzle-orm";\nimport { DatabaseError }     from "pg-protocol";\n\n// Relevant codes from: https://www.postgresql.org/docs/current/errcodes-appendix.html\n\nexport enum OPSTATUS {\n    SUCCESS,\n    // integrity violations\n    FOREIGN_KEY_VIOLATION=23503,\n    UNIQUE_VIOLATION=23505,\n    CHECK_VIOLATION=23514,\n    NOT_NULL_VIOLATION=23502,\n\n    // transaction failure\n    INVALID_TRANSACTION_STATE=25000,\n\n    // connection failure\n    CONNECTION_DOES_NOT_EXIST=8006,\n    CONNECTION_FAILURE=8006,\n\n    // other\n    UNKNOWN_FAILURE=-1,\n}\n\n// ...\n\n    try {\n        const insertedUser = await db.insert(usersSchema).values(user).returning();\n\n        if ( insertedUser[0] === undefined ) {\n            throw new Error("Unknown Failure"); // handled below\n        }\n\n        return insertedUser[0];\n    }\n\n    catch (err: any) {\n\n        // if error has not originated from pg driver, no useful information can be extracted\n        if ( !(err instanceof DrizzleQueryError) || !(err.cause instanceof DatabaseError) ) {\n            return {\n                success: false,\n                status: OPSTATUS.UNKNOWN_FAILURE,\n                message: "Unknown Failure"\n            }\n        }\n\n        // ...\n\n        // try to find out what went wrong?\n        switch (errCode) {\n\n            case OPSTATUS.UNIQUE_VIOLATION: {\n                recommendedHttpResponseCode = StatusCodes.CONFLICT;\n                message = "User already exists";\n                break;\n            }\n            case OPSTATUS.CONNECTION_FAILURE: {\n                recommendedHttpResponseCode = StatusCodes.SERVICE_UNAVAILABLE;\n                message = "Broken connection to database server";\n                break;\n            }\n            // and so on..\n        }\n\n        // return approapriate response\n    }\n\n'})})]})}function h(e={}){const{wrapper:r}={...(0,t.R)(),...e.components};return r?(0,o.jsx)(r,{...e,children:(0,o.jsx)(l,{...e})}):l(e)}}}]);